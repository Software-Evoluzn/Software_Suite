<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" type="image/png" href="../static/img/evoluzn_title_logo.png">
    <link href="../static/css/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="../static/css/btb_graph.css">
    <link rel="stylesheet" href="../static/css/btb4channel.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    <!-- MOBILE HAMBURGER -->
    <button class="btn btn-primary d-lg-none m-2" onclick="toggleMobileSidebar()">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- SIDEBAR -->
    {% include 'navbar.html' %}

    <div class="main_content ">

        <div class="dashboard-header">
            <div class="p-3">
                <a href="{{ url_for('btb4channel') }}" class="btn btn-primary d-inline-flex align-items-center gap-2">
                    <img src="../static/img/left_arrow.svg" width="16" height="16">
                    <span>Go Back</span>
                </a>
            </div>

            <h2 class="dashboard-title">GRAPH DASHBOARD</h2>

        </div>

        <div class="d-flex flex-column">

            <div class="dashboard-box relative">
                <div class="section-title" data-device="BTB4ChannelF0BFD5">4 CHANNEL BTB</div>

                <div class="btb-main">

                    <div class="btb-left">
                        <h2 class="btb-title">MASTER BTB</h2>
                        <p class="btb-subtitle">(Control all BTBs with one switch)</p>
                        <label class="switch large-switch">
                            <input type="checkbox" id="btbMasterSwitch" data-device="4Channel" />
                            <span class="slider"></span>
                        </label>
                        <div class="switch-labels">
                            <span class="off">OFF</span>
                            <span class="on">ON</span>
                        </div>

                        <div class="btb-right">
                            <div class="btb-grid">

                                <div class="btb-light">
                                    <h3>BTB 1</h3>
                                    <label class="switch">
                                        <input type="checkbox" class="btbSwitch" data-device="BTB1" />
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="btb-light">
                                    <h3>BTB 2</h3>
                                    <label class="switch">
                                        <input type="checkbox" class="btbSwitch" data-device="BTB2" />
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="btb-light">
                                    <h3>BTB 3</h3>
                                    <label class="switch">
                                        <input type="checkbox" class="btbSwitch" data-device="BTB3" />
                                        <span class="slider"></span>
                                    </label>

                                </div>

                                <div class="btb-light">
                                    <h3>BTB 4</h3>
                                    <label class="switch">
                                        <input type="checkbox" class="btbSwitch" data-device="BTB4" />
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="right-side">
                        <div class="filter-group">
                            <select id="modeSelect" class="filter-select">
                                <option value="today" selected>Today</option>
                                <option value="range">Range</option>
                            </select>

                            <select id="graphType" class="filter-select">
                                <option value="power" selected>Power</option>
                                <option value="voltage">Voltage</option>
                                <option value="current">Current</option>
                            </select>

                        </div>

                        <button style="display: none;" class="btn" id="loadDataBtn">Apply</button>

                    </div>

                    <div id="dateRangeInputs" class="date-range-container" style="display:none;">
                        <label>Select Range:</label><br>
                        <input type="date" id="startDate" class="date-input" />
                        <span class="date-separator">â†’</span>
                        <input type="date" id="endDate" class="date-input" />
                    </div>

                    <div class="chart-container">
                        <canvas id="powerChart"></canvas>
                        <h3 id="chartLabelText"
                            style="text-align:center; margin-top:15px; font-weight:600; color:#444;">
                        </h3>

                    </div>
                </div>
            </div>
        </div>

    </div>

    {% include 'footer.html' %}

    <script src="../static/js/socket.io.js"></script>
    <script src="../static/js/btb_graph.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const deviceId = params.get("device_id");

        if (deviceId) {
            // Find the element and update data-device attribute
            const sectionTitle = document.querySelector(".section-title");
            sectionTitle.setAttribute("data-device", deviceId);
        }

        const device_data = {{ device_data | tojson }};
        console.log("sejal want to see data ", device_data)

        let device = "";
        const singleMasterSwitch = document.getElementById("singleMasterSwitch");
        const btbMasterSwitch = document.getElementById("btbMasterSwitch");
        const btbSwitches = document.querySelectorAll(".btbSwitch");

        console.log("Device ID:", deviceId);

        btbSwitches.forEach((btbSwitch) => {
            btbSwitch.addEventListener("change", function () {
                const intensity = this.checked ? 100 : 0;
                const relay = this.dataset.device;   // BTB1 / BTB2 / BTB3 / BTB4

                const fullDevice = `BTB4Channel:${deviceId}:${relay}`;

                console.log("Sending:", fullDevice, intensity);

                socket.emit("toggle_device", {
                    device: fullDevice,
                    intensity: intensity
                });

                // Sync master
                btbMasterSwitch.checked =
                    Array.from(btbSwitches).some(sw => sw.checked);
            });
        });



        btbMasterSwitch.addEventListener("change", function () {
            const intensity = this.checked ? 100 : 0;

            btbSwitches.forEach(sw => sw.checked = this.checked);

            socket.emit("toggle_device", {
                device: `BTB4Channel:${deviceId}:ALL`,
                intensity: intensity
            });
        });
        // Initial load
        if (device_data) {

            // ---------- EXISTING CODE (UNCHANGED) ----------
            const Single_Phase = device_data["Single_Phase"];
            const BTB = device_data["BTB4Channel"];

            if (Single_Phase) {
                if (Single_Phase.load_status === '0') {
                    singleMasterSwitch.checked = false;
                } else if (Single_Phase.load_status === '1') {
                    console.log("Single Phase load_status is valid.");
                    singleMasterSwitch.checked = true;
                }
            }

            if (BTB) {
                const { relay1, relay2, relay3, relay4 } = BTB;

                btbSwitches.forEach((btbSwitch, index) => {
                    const relayState = [relay1, relay2, relay3, relay4][index];
                    btbSwitch.checked = relayState === 1;
                });

                const anySwitchOn = Array.from(btbSwitches).some(s => s.checked);
                btbMasterSwitch.checked = anySwitchOn;
            }

            // ---------- ðŸ”¥ NEW ADDITION (DEVICE-ID BASED SUPPORT) ----------
            // This runs ONLY if device_data has entry like:
            // device_data["BTB4ChannelF0BFD5"]

            if (deviceId && device_data[deviceId]) {
                console.log("âœ… Using deviceId-based data:", deviceId);

                const { relay1, relay2, relay3, relay4 } = device_data[deviceId];
                const relays = [relay1, relay2, relay3, relay4];

                btbSwitches.forEach((sw, i) => {
                    sw.checked = relays[i] === 1;
                });

                btbMasterSwitch.checked = relays.some(r => r === 1);
            }
        }

    </script>
</body>



</html>
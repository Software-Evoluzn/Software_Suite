<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="../static/css/bootstrap.css" rel="stylesheet" />
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .device-card {
            width: 400px;
            height: 120px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .device-card.no-warning .device-content {
            height: 100%;
            display: flex;
            align-items: center;
        }


        /* Top Warning Bar */
        .warning-bar {
            background: #ff4756e8;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .warning-icon {
            font-size: 16px;
        }

        /* Main Content */
        .device-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
        }

        .device-name {
            margin: 0;
            font-size: 18px;
        }

        .status {
            font-size: 14px;
        }


        /* Right Side Icons */
        .right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Arrow Button */
        .arrow-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #e5e7eb;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #374151;
        }
    </style>
    <style>
        .device-card {
            width: 570px;
            height: 120px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .device-card.no-warning .device-content {
            height: 100%;
            display: flex;
            align-items: center;
        }


        /* Top Warning Bar */
        .warning-bar {
            background: #ff4756e8;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .warning-icon {
            font-size: 16px;
        }

        /* Main Content */
        .device-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
        }

        .status {
            font-size: 14px;
        }


        /* Right Side Icons */
        .right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Arrow Button */
        .arrow-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #e5e7eb;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #374151;
        }

        .early_warning {
            background-color: #fbfdc6;
        }

        /* üî¥‚ö™ Blink animation */
        @keyframes alertBlink {
            0% {
                background-color: #ffffff;
            }

            50% {
                background-color: #ffc8cb;
            }

            100% {
                background-color: #ffb7b7;
            }
        }

        /* Apply blinking ONLY to alert cards */
        .device-card.alert-active {
            animation: alertBlink 2s infinite;
        }
    </style>
</head>

<body>
    <!-- MOBILE HAMBURGER -->
    <div class="d-block d-md-none">
        <button class="btn btn-primary d-lg-none m-2" onclick="toggleMobileSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>

        WTS Dashboard
    </div>

    <!-- SIDEBAR -->
    {% include 'navbar.html' %}

    <div class="main_content d-flex flex-column">

        {# -------- PREPARE ALERT DEVICE NAME SAFELY -------- #}
        {% set alert_device_names = [] %}

        {% if alerts %}
        {% for a in alerts %}
        {% set _ = alert_device_names.append(a.device_name | replace("Alert", "")) %}
        {% endfor %}
        {% endif %}

        <div id="device-container" class="d-flex flex-row flex-wrap p-4 gap-4">

            {# ===================== SHOW ALERT DEVICES FIRST ===================== #}
            {% for device_name, panels in device_data.items() %}

            {% if device_name in alert_device_names %}
            {% set status = panels.get('status', 'offline') %}
            <div class="device-card  alert-active" data-device-id="{{ device_name }}"
                data-device-label="{{ panels.device_location if panels.device_location else device_name }}"
                onclick="openRenameModal(this)">
                <div class="warning-bar">
                    <span class="warning-icon">‚ö†</span>
                    Temperature threshold exceeded
                </div>

                <div class="device-content">
                    <div class="left">
                        <h3 class="device-name">{{ panels.device_location if panels.device_location else device_name
                            }}
                        </h3>
                        <span class="status {{ 'online' if status == 'online' else 'offline' }}">
                            ({{device_name}}) - {{ status.capitalize() }}
                        </span>
                    </div>

                    <div class="right">
                        <!-- Ripple SVG -->
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"
                            class="{% if status == 'online' %}ripple-online{% else %}ripple-offline{% endif %}">
                            <circle cx="20" cy="20" r="6"
                                fill="{% if status == 'online' %}#10B981{% else %}#EF4444{% endif %}" opacity="0.7">
                                <animate attributeName="r" from="6" to="18" dur="1.6s" repeatCount="indefinite" />
                                <animate attributeName="opacity" from="0.7" to="0" dur="1.6s"
                                    repeatCount="indefinite" />
                            </circle>
                            <circle cx="20" cy="20" r="6"
                                fill="{% if status == 'online' %}#10B981{% else %}#EF4444{% endif %}" />
                        </svg>

                        <!-- Wi-Fi images -->
                        <img src="../static/img/wifi.png" alt="Wi-Fi_Online" class="wifi-online"
                            style="display: {% if status == 'online' %}inline{% else %}none{% endif %};">
                        <img src="../static/img/wifi_off.png" alt="Wi-Fi_Offline" class="wifi-offline"
                            style="display: {% if status != 'online' %}inline{% else %}none{% endif %};">

                        <!-- Arrow Button -->
                        <button class="arrow-btn" onclick="event.stopPropagation()">
                            <a href="{{ url_for('temperature', device_id=device_name) }}"
                                class="dashboard_indv_nav_img_div">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                                    aria-hidden="true">
                                    <path d="M9 6l6 6-6 6" stroke="#3b82f6" stroke-width="2.3" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </a>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {# ===================== SHOW NORMAL DEVICES BELOW ===================== #}
            {% for device_name, panels in device_data.items() %}

            {% if device_name not in alert_device_names %}
            {% set status = panels.get('status', 'offline') %}
            <div class="device-card no-warning" data-device-id="{{ device_name }}"
                data-device-label="{{ panels.device_location if panels.device_location else device_name }}"
                onclick="openRenameModal(this)">
                <div class="device-content">
                    <div class="left">
                        <h3 class="device-name">{{ panels.device_location if panels.device_location else device_name
                            }}
                        </h3>
                        <span class="status {{ 'online' if status == 'online' else 'offline' }}">
                            ({{device_name}}) - {{ status.capitalize() }}
                        </span>
                    </div>

                    <div class="right">
                        <!-- Ripple SVG -->
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"
                            class="{% if status == 'online' %}ripple-online{% else %}ripple-offline{% endif %}">
                            <circle cx="20" cy="20" r="6"
                                fill="{% if status == 'online' %}#10B981{% else %}#EF4444{% endif %}" opacity="0.7">
                                <animate attributeName="r" from="6" to="18" dur="1.6s" repeatCount="indefinite" />
                                <animate attributeName="opacity" from="0.7" to="0" dur="1.6s"
                                    repeatCount="indefinite" />
                            </circle>
                            <circle cx="20" cy="20" r="6"
                                fill="{% if status == 'online' %}#10B981{% else %}#EF4444{% endif %}" />
                        </svg>

                        <!-- Wi-Fi images -->
                        <img src="../static/img/wifi.png" alt="Wi-Fi_Online" class="wifi-online"
                            style="display: {% if status == 'online' %}inline{% else %}none{% endif %};">
                        <img src="../static/img/wifi_off.png" alt="Wi-Fi_Offline" class="wifi-offline"
                            style="display: {% if status != 'online' %}inline{% else %}none{% endif %};">

                        <!-- Arrow Button -->
                        <button class="arrow-btn" onclick="event.stopPropagation()">
                            <a href="{{ url_for('temperature', device_id=device_name) }}"
                                class="dashboard_indv_nav_img_div">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                                    aria-hidden="true">
                                    <path d="M9 6l6 6-6 6" stroke="#3b82f6" stroke-width="2.3" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </a>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% include 'rename_device.html' %}

        </div>

    </div>

    {% include 'footer.html' %}

    <script src="../static/js/socket.io.js"></script>


    <script>
        let socket;
        // document.addEventListener('DOMContentLoaded', function () {

        //     flatpickr("#dateRange", {
        //         mode: "range",          // Enable range
        //         dateFormat: "Y-m-d",    // DB friendly format
        //         allowInput: false,

        //         onChange: function (selectedDates, dateStr) {

        //             if (selectedDates.length === 2) {

        //                 const startDate = selectedDates[0];
        //                 const endDate = selectedDates[1];
        //             }
        //         }
        //     });

        // });


        fetch('static/js/ip.json')
            .then(response => response.json())
            .then(data => {
                const serverIP = data.ip;
                console.log("Fetched IP:", serverIP);

                // Create socket here
                socket = io.connect(serverIP);

                socket.on('status_update', function (data) {
                    const deviceId = data.device_id;
                    const status = data.device_status;

                    // ‚úÖ Select card by data attribute
                    const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
                    if (!card) return;

                    // ‚úÖ Update status text
                    const statusSpan = card.querySelector('.status');
                    const currentText = statusSpan.textContent;
                    const parts = currentText.split('-');
                    statusSpan.textContent = `${parts[0].trim()} - ${status === 'online' ? 'Online' : 'Offline'}`;
                    statusSpan.classList.remove(status === 'online' ? 'offline' : 'online');
                    statusSpan.classList.add(status === 'online' ? 'online' : 'offline');

                    // ‚úÖ Update Wi-Fi icons
                    const wifiOnline = card.querySelector('img[alt="Wi-Fi_Online"]');
                    const wifiOffline = card.querySelector('img[alt="Wi-Fi_Offline"]');
                    if (status === 'online') {
                        if (wifiOnline) wifiOnline.style.display = 'inline';
                        if (wifiOffline) wifiOffline.style.display = 'none';
                    } else {
                        if (wifiOnline) wifiOnline.style.display = 'none';
                        if (wifiOffline) wifiOffline.style.display = 'inline';
                    }

                    // ‚úÖ Update ripple circles
                    const rippleCircles = card.querySelectorAll('svg circle');
                    rippleCircles.forEach(circle => {
                        circle.setAttribute('fill', status === 'online' ? '#10B981' : '#EF4444');
                    });
                });

                // üî•üî• Listen for new alerts
                socket.on('new_alert', function (data) {
                    console.log("üî• New Alert Received:", data);

                    // 1Ô∏è‚É£ Validate incoming data
                    if (!data || !data.device_name) {
                        console.warn("‚ö† Invalid alert data", data);
                        return;
                    }

                    // 2Ô∏è‚É£ Get alertDevice value
                    const alertDevice = data.device_name.replace("Alert", "");

                    // 3Ô∏è‚É£ Try to match device card using data-device-id
                    const deviceCard = document.querySelector(
                        `.device-card[data-device-id="${alertDevice}"]`
                    );

                    // 4Ô∏è‚É£ If not found ‚Üí stop here
                    if (!deviceCard) {
                        console.warn("‚ùå No matching device card found for:", alertDevice);
                        return;
                    }

                    // 5Ô∏è‚É£ Get container
                    const container = document.getElementById("device-container");
                    if (!container) return;

                    // 6Ô∏è‚É£ Add warning bar ONLY if not already present
                    if (!deviceCard.querySelector(".warning-bar")) {
                        const bar = document.createElement("div");
                        bar.className = "warning-bar";
                        bar.innerHTML = `
            <span class="warning-icon">‚ö†</span>
            Temperature threshold exceeded
        `;

                        deviceCard.insertBefore(bar, deviceCard.firstChild);
                        deviceCard.classList.add("alert-active");
                        deviceCard.classList.remove("no-warning", "early_warning");
                    }

                    // 7Ô∏è‚É£ Move alert device to top
                    if (container.firstChild !== deviceCard) {
                        container.prepend(deviceCard);
                    }
                });

                // for the filtering of alerts - currently disabled
                // socket.on("filtered_alerts", function (data) {
                //     console.log("Received Hurray:", data);

                //     const alerts = data.alerts;
                //     const alertDeviceNames = alerts.map(a => a.device_name.replace("Alert", ""));

                //     document.querySelectorAll(".device-card").forEach(card => {
                //         const deviceId = card.dataset.deviceId.replace("Alert", "");
                //         if (alertDeviceNames.includes(deviceId)) {
                //             card.style.display = "block";
                //         } else {
                //             card.style.display = "none";
                //         }
                //     });
                // });

                // socket.on('home_page', function (data) {
                //     console.log("üì° Sensor Data Received:", data);

                //     const deviceCard = document.querySelector(`.device-card[data-device-id="${data.device_id}"]`);
                //     if (!deviceCard) return;

                //     if (!deviceCard.classList.contains("no-warning")) return;

                //     const threshold = data.threshold;
                //     if (threshold === null || threshold === undefined) return;

                //     // Check all sensor values
                //     const sensorValues = [
                //         data.R1, data.Y1, data.B1,
                //         data.R2, data.Y2, data.B2,
                //         data.R3, data.Y3, data.B3,
                //         data.N
                //     ];

                //     // If any value >= threshold - 3 ‚Üí mark critical
                //     const isCritical = sensorValues.some(val => val !== null && val >= threshold - 3);

                //     if (isCritical) {
                //         deviceCard.classList.add("early_warning"); // apply your CSS
                //     } else {
                //         deviceCard.classList.remove("early_warning");
                //     }
                // });

            })
            .catch(error => {
                console.error('Error fetching IP configuration:', error);
            });

        // function applyFilter() {

        //     const unit = document.getElementById("deviceUnit").value;
        //     const dateRange = document.getElementById("dateRange").value;

        //     let startDate = "";
        //     let endDate = "";

        //     if (dateRange.includes(" to ")) {
        //         const parts = dateRange.split(" to ");
        //         startDate = parts[0];
        //         endDate = parts[1];
        //     } else if (dateRange) {
        //         startDate = dateRange;
        //         endDate = dateRange; // Same date for both
        //     }
        //     const data = {
        //         device_unit: unit,
        //         start_date: startDate,
        //         end_date: endDate
        //     };

        //     console.log("Sending:", data);

        //     const filterList = document.getElementById("filter_list");
        //     filterList.innerHTML = ""; // Clear existing filters

        //     if (unit) {
        //         const unitTag = document.createElement("span");
        //         unitTag.className = "badge bg-primary d-flex align-items-center gap-1";
        //         unitTag.innerHTML = `${unit} <button class="btn-close btn-close-white btn-sm" onclick="resetFilter('unit')"></button>`;
        //         filterList.appendChild(unitTag);
        //     }

        //     if (dateRange) {
        //         const dateTag = document.createElement("span");
        //         dateTag.className = "badge bg-success d-flex align-items-center gap-1";
        //         dateTag.innerHTML = `${dateRange} <button class="btn-close btn-close-white btn-sm" onclick="resetFilter('date')"></button>`;
        //         filterList.appendChild(dateTag);
        //     }

        //     // ‚úÖ Emit to backend
        //     socket.emit("filter_alerts_home", data);
        // }

        // // Reset specific filter
        // function resetFilter(type) {
        //     if (type === "unit") {
        //         document.getElementById("deviceUnit").value = "ALL";
        //     } else if (type === "date") {
        //         document.getElementById("dateRange").value = "";
        //     }

        //     // Clear filter tags UI
        //     document.getElementById("filter_list").innerHTML = "";

        //     // Show all devices
        //     document.querySelectorAll(".device-card").forEach(card => {
        //         card.style.display = "block";
        //     });
        // }

    </script>

    <script>
        function openRenameModal(card) {
            const deviceId = card.dataset.deviceId;      // REAL ID (backend)
            const deviceLabel = card.dataset.deviceLabel; // Shown name (UI)

            document.getElementById('deviceId').value = deviceId;
            document.getElementById('newDeviceName').value = deviceLabel;

            const modal = new bootstrap.Modal(
                document.getElementById('renameDeviceModal')
            );
            modal.show();
        }

        function saveDeviceName() {
            const deviceId = document.getElementById('deviceId').value;
            const newName = document.getElementById('newDeviceName').value.trim();

            console.log("Renaming Device:", deviceId, "to", newName);

            fetch('/rename-device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device_name: deviceId,   // ‚úÖ ORIGINAL device_name
                    device_location: newName // ‚úÖ NEW display name
                })
            })
                .then(r => r.json())
                .then(() => location.reload());
        }


    </script>
</body>

</html>